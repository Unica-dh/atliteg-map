name: Deploy to Production

# Trigger automatico su push/merge al ramo master
on:
  push:
    branches:
      - master
  workflow_dispatch: # Permette esecuzione manuale dal tab Actions

# Permessi necessari per il workflow
permissions:
  contents: read

jobs:
  deploy:
    name: Deploy AtLiTeG Map Application
    # Usa il self-hosted runner installato sul server
    runs-on: self-hosted
    
    # Environment per gestire secrets e protezioni
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    
    steps:
      # Step 1: Informazioni di avvio
      - name: ğŸš€ Inizio Deploy
        run: |
          echo "================================================"
          echo "ğŸš€ Avvio procedura di deploy automatico"
          echo "================================================"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autore commit: ${{ github.actor }}"
          echo "ğŸ’¬ Messaggio commit: ${{ github.event.head_commit.message }}"
          echo "ğŸ–¥ï¸  Server: $(hostname)"
          echo "ğŸ‘¤ User: $(whoami)"
          echo "ğŸ“‚ Working directory: $(pwd)"
          echo "================================================"
      
      # Step 2: Git Pull
      - name: ğŸ“¥ Git Pull del codice aggiornato
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ STEP 1: Pulling latest code from repository"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ“ Directory corrente: $(pwd)"
          echo "ğŸŒ¿ Branch corrente: $(git branch --show-current)"
          
          # Salva modifiche locali se esistono
          if [[ -n $(git status -s) ]]; then
            echo "âš ï¸  Modifiche locali rilevate, eseguo stash..."
            git stash
          fi
          
          # Pull del codice
          echo "ğŸ“¥ Download ultimi aggiornamenti..."
          git fetch origin master
          git checkout master
          git pull origin master
          
          echo "âœ… Git pull completato con successo"
          echo "ğŸ“Š Ultimo commit: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"

      # Step 3: Sincronizza risorse statiche
      - name: ğŸ“‹ Sincronizza risorse statiche
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ STEP 2: Syncing static assets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          cd ${{ secrets.DEPLOY_PATH }}

          echo "ğŸ“‚ Sincronizzazione directory data..."

          # Copia ricorsiva mantenendo la struttura, sovrascrivendo file esistenti
          # -r: ricorsivo
          # -v: verbose
          # -u: copia solo file piÃ¹ recenti
          cp -rvu lemmario-dashboard/public/data/* data/ 2>&1 | grep -v "omitted directory" || true

          echo "âœ… Risorse statiche sincronizzate"
          echo "ğŸ“ Contenuto directory data:"
          ls -lh data/

          if [ -d "data/logo" ]; then
            echo ""
            echo "ğŸ“ Contenuto directory data/logo:"
            ls -lh data/logo/
          fi

      # Step 4: Build frontend Next.js
      - name: ğŸ—ï¸ Build frontend Next.js
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—ï¸  STEP 3: Building Next.js frontend"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}/lemmario-dashboard
          
          echo "ğŸ“¦ Installing frontend dependencies..."
          npm install
          
          echo "ğŸ”¨ Building Next.js application..."
          # NEXT_PUBLIC_API_URL= (empty) makes API calls relative (e.g., /api/lemmi)
          # Nginx then proxies these to backend:3001 (see nginx.conf)
          # NEXT_PUBLIC_API_KEY is a build-time placeholder - real validation happens at backend
          NEXT_PUBLIC_API_URL= NEXT_PUBLIC_API_KEY=default_dev_key npm run build
          
          echo "âœ… Frontend build completato con successo"
          echo "ğŸ“ Verifica directory out:"
          ls -lh out/ | head -20

      # Step 5: Installazione dipendenze backend
      - name: ğŸ“¦ Installazione dipendenze backend
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ STEP 4: Installing backend dependencies"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}/lemmario-dashboard/server
          
          echo "ğŸ“¦ Installing backend dependencies..."
          npm install
          
          echo "âœ… Backend dependencies installate con successo"

      # Step 6: Build dell'applicazione Docker
      - name: ğŸ³ Build Docker containers
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ STEP 5: Building Docker containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ”¨ Esecuzione docker compose build..."
          docker compose build --no-cache
          
          echo "âœ… Build completato con successo"
          echo "ğŸ“‹ Immagini Docker disponibili:"
          docker images | grep atliteg || echo "Nessuna immagine atliteg trovata"
      
      # Step 7: Restart dei container
      - name: ğŸ”„ Restart dei container
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ STEP 6: Restarting application containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Stop containers esistenti
          echo "ğŸ›‘ Stopping running containers..."
          docker compose down
          
          # Start nuovi containers
          echo "â–¶ï¸  Starting new containers..."
          docker compose up -d
          
          # Attendi che i container siano healthy
          echo "â³ Waiting for containers to be healthy (10 secondi)..."
          sleep 10
          
          echo "âœ… Container riavviati con successo"
      
      # Step 8: Pulizia risorse Docker
      - name: ğŸ§¹ Pulizia risorse Docker
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¹ Pulizia risorse Docker inutilizzate"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ—‘ï¸  Rimozione immagini dangling..."
          docker image prune -f
          
          echo "ğŸ—‘ï¸  Rimozione volumi non utilizzati..."
          docker volume prune -f
          
          echo "âœ… Pulizia completata"
      
      # Step 9: Verifica deployment
      - name: ğŸ” Verifica deployment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifica finale del deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ“Š Container in esecuzione:"
          docker compose ps
          
          # Verifica health check
          CONTAINER_NAME="atliteg-lemmario-dashboard"
          if docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null | grep -q "healthy\|starting"; then
            echo "âœ… Container $CONTAINER_NAME is running and healthy"
          elif docker inspect --format='{{.State.Status}}' $CONTAINER_NAME 2>/dev/null | grep -q "running"; then
            echo "âœ… Container $CONTAINER_NAME is running"
          else
            echo "âš ï¸  Warning: Could not verify container health status"
          fi
          
          echo ""
          echo "ğŸ“ Log recenti (ultime 20 righe):"
          docker compose logs --tail=20
          
          echo ""
          echo "ğŸ’¾ Utilizzo disco:"
          df -h | grep -E '(Filesystem|/$)'
          
          echo "âœ… Verifica completata"
      
      # Step 10: Notifica risultato
      - name: ğŸ‰ Deploy completato
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOY COMPLETATO CON SUCCESSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Codice aggiornato"
          echo "âœ… Applicazione ribuildata"
          echo "âœ… Container riavviati"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”– Version: $(cd ${{ secrets.DEPLOY_PATH }} && git describe --tags --always)"
          echo "ğŸŒ L'applicazione Ã¨ ora accessibile"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Step 11: Deployment Summary (per GitHub)
      - name: ğŸ“¢ Deployment Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        âœ… DEPLOY PRODUCTION SUCCESSFUL âœ…              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
      
      # Step 12: Gestione errori
      - name: ğŸš¨ Notifica errore
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âŒ DEPLOY PRODUCTION FAILED âŒ                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  Si Ã¨ verificato un errore durante il deploy"
          echo "ğŸ” Controlla i log sopra per maggiori dettagli"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
