name: Deploy to Production

# Trigger automatico su push/merge al ramo master
on:
  push:
    branches:
      - master
  workflow_dispatch: # Permette esecuzione manuale dal tab Actions

# Permessi necessari per il workflow
permissions:
  contents: read

jobs:
  deploy:
    name: Deploy AtLiTeG Map Application
    runs-on: ubuntu-latest
    
    # Environment per gestire secrets e protezioni
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    
    steps:
      # Step 1: Checkout del codice (opzionale, per validazione)
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Step 2: Setup SSH
      - name: ğŸ” Configure SSH Connection
        run: |
          echo "ğŸ”‘ Configurazione chiave SSH per connessione al server remoto..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Aggiungi l'host ai known_hosts per evitare prompt
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "âœ… Chiave SSH configurata con successo"
      
      # Step 3: Verifica connessione SSH
      - name: ğŸ” Test SSH Connection
        run: |
          echo "ğŸ§ª Test della connessione SSH al server remoto..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo 'âœ… Connessione SSH stabilita con successo' && whoami && pwd"
      
      # Step 4: Deploy applicazione sul server remoto
      - name: ğŸš€ Deploy Application on Remote Server
        run: |
          echo "ğŸš€ Inizio processo di deploy sul server remoto..."
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
          
          set -e  # Exit immediatamente in caso di errore
          
          echo "ğŸ“‚ Navigazione alla directory del progetto..."
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "ğŸ“ Directory corrente: $(pwd)"
          echo "ğŸŒ¿ Branch corrente: $(git branch --show-current)"
          
          # STEP 1: Git Pull
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ STEP 1: Pulling latest code from repository"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Salva modifiche locali se esistono
          if [[ -n $(git status -s) ]]; then
            echo "âš ï¸  Modifiche locali rilevate, eseguo stash..."
            git stash
          fi
          
          # Pull del codice
          git fetch origin master
          git checkout master
          git pull origin master
          
          echo "âœ… Git pull completato con successo"
          echo "ğŸ“Š Ultimo commit: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"
          
          # STEP 2: Build dell'applicazione
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—ï¸  STEP 2: Building application containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Build con docker compose
          echo "ğŸ”¨ Esecuzione docker compose build..."
          docker compose build --no-cache
          
          echo "âœ… Build completato con successo"
          
          # STEP 3: Restart dei container
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ STEP 3: Restarting application containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Stop containers esistenti
          echo "ğŸ›‘ Stopping running containers..."
          docker compose down
          
          # Start nuovi containers
          echo "â–¶ï¸  Starting new containers..."
          docker compose up -d
          
          # Attendi che i container siano healthy
          echo "â³ Waiting for containers to be healthy..."
          sleep 10
          
          # Verifica stato containers
          echo "ğŸ” Checking container status..."
          docker compose ps
          
          # Verifica health check
          CONTAINER_NAME="atliteg-lemmario-dashboard"
          if docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null | grep -q "healthy\|starting"; then
            echo "âœ… Container $CONTAINER_NAME is running and healthy"
          elif docker inspect --format='{{.State.Status}}' $CONTAINER_NAME 2>/dev/null | grep -q "running"; then
            echo "âœ… Container $CONTAINER_NAME is running"
          else
            echo "âš ï¸  Warning: Could not verify container health status"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOY COMPLETATO CON SUCCESSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”– Version: $(git describe --tags --always)"
          
          ENDSSH
          
          echo ""
          echo "âœ¨ Deploy completato sul server remoto!"
      
      # Step 5: Cleanup
      - name: ğŸ§¹ Cleanup SSH Keys
        if: always()
        run: |
          echo "ğŸ§¹ Rimozione chiavi SSH temporanee..."
          rm -rf ~/.ssh/deploy_key
          echo "âœ… Cleanup completato"
      
      # Step 6: Notifica risultato
      - name: ğŸ“¢ Deployment Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                        â•‘"
          echo "â•‘        âœ… DEPLOY PRODUCTION SUCCESSFUL âœ…              â•‘"
          echo "â•‘                                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
      
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                        â•‘"
          echo "â•‘          âŒ DEPLOY PRODUCTION FAILED âŒ                â•‘"
          echo "â•‘                                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  Si Ã¨ verificato un errore durante il deploy"
          echo "ğŸ” Controlla i log sopra per maggiori dettagli"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          exit 1
